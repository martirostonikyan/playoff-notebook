<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ë–ª–æ–∫–Ω–æ—Ç –¥–ª—è –ø–ª–µ–π-–æ—Ñ—Ñ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      max-width: 1000px;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { text-align: center; margin-bottom: 20px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th { background: #eee; }
    input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    .result {
      margin-top: 30px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
    }
    button {
      display: inline-block;
      margin: 10px 10px 20px 0;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

<h1>–ë–ª–æ–∫–Ω–æ—Ç –¥–ª—è –ø–ª–µ–π-–æ—Ñ—Ñ</h1>

<table id="playersTable">
  <thead>
    <tr>
      <th>–ò–≥—Ä–æ–∫</th>
      <th>–í—Ä–µ–º—è —Å—É–±–±–æ—Ç—ã 1</th>
      <th>–í—Ä–µ–º—è —Å—É–±–±–æ—Ç—ã 2</th>
      <th>–í—Ä–µ–º—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è 1</th>
      <th>–í—Ä–µ–º—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è 2</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<button onclick="calculateOptimal()">–ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è</button>
<button onclick="init()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>

<div class="result" id="results"></div>

<script>
  const players = [
    "–ê–¥–∏–ª–≥–∞–ª–∏–µ–≤",
    "–í–∞—Å–∏–ª—å–µ–≤",
    "–ì—Ä–∏–≥–æ—Ä—å–µ–≤",
    "–î–µ–ª–∏–Ω—å—è–Ω",
    "–ï—Ä—à–æ–≤",
    "–ö—É–∑–Ω–µ—Ü–æ–≤",
    "–ú–æ–∏—Å–µ–µ–≤",
    "–ü–µ—Ç—Ä–æ–≤",
    "–†–∞—á–µ–≤",
    "–°–∞–≤–∏–Ω",
    "–°–∞—Ñ—Ä—ã–≥–∏–Ω",
    "–°–∏–¥–æ—Ä–æ–≤",
    "–¢–æ–Ω–∏–∫—è–Ω",
    "–¢—Ä–µ—Å–∫–∏–Ω",
    "–®–∏—Ä–æ–∫–æ–≤"
  ];

  const fields = ["sat1", "sat2", "sun1", "sun2"];

  // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ JSONBin.io
  const BIN_ID = '682b4ef78960c979a59cfbf0';
  const API_KEY = '$2a$10$.gwzdXej8Y3r5xYlrDSBMeoT7bppAIeQyN8uDMh5MbJIi1K41ZoLa';

  function parseTime(time) {
    if (!time || !/^\d{1,2}:\d{2}$/.test(time)) return null;
    const [hours, minutes] = time.split(":").map(Number);
    if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) return null;
    return new Date(1970, 0, 1, hours, minutes);
  }

  function findOptimalTime(times) {
    const validTimes = times.map(time => {
      if (!time || !time.includes("-")) return null;
      const [startStr, endStr] = time.split("-");
      const start = parseTime(startStr.trim());
      const end = parseTime(endStr.trim());
      return start && end && end > start ? { start: start.getTime(), end: end.getTime() } : null;
    }).filter(Boolean);

    if (validTimes.length === 0) return { time: "‚Äî", players: [] };

    let bestOverlap = { duration: 0, start: 0, end: 0, players: [] };

    validTimes.forEach((interval1, i1) => {
      const overlapStart = interval1.start;
      const overlapEnd = interval1.end;

      const overlappingPlayers = validTimes
        .map((interval2, i2) => interval2 && interval1.start <= interval2.end && interval1.end >= interval2.start ? i2 : -1)
        .filter(i => i !== -1);

      const duration = overlapEnd - overlapStart;

      if (
        duration > bestOverlap.duration ||
        (duration === bestOverlap.duration && overlappingPlayers.length > bestOverlap.players.length)
      ) {
        bestOverlap = { duration, start: overlapStart, end: overlapEnd, players: overlappingPlayers };
      }
    });

    if (bestOverlap.duration === 0) return { time: "–ù–µ—Ç –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏", players: [] };

    const formatTime = ts => {
      const date = new Date(ts);
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    };

    const optimalTime = `${formatTime(bestOverlap.start)} ‚Äî ${formatTime(bestOverlap.end)}`;
    const playerNames = bestOverlap.players.map(i => players[i]);

    return { time: optimalTime, players: playerNames };
  }

  async function loadDataFromServer() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/ ${BIN_ID}/latest`, {
        headers: {
          'X-Master-Key': API_KEY
        }
      });
      const data = await res.json();
      return data.record || {};
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
      return {};
    }
  }

  async function saveDataToServer(data) {
    try {
      await fetch(`https://api.jsonbin.io/v3/b/ ${BIN_ID}`, {
        method: "PUT",
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': API_KEY
        },
        body: JSON.stringify(data)
      });
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", e);
    }
  }

  async function renderTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    players.forEach((player, index) => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${player}</td>
        ${fields.map(f => {
          const value = (data[player] && data[player][f]) || "";
          return `<td><input type="text" placeholder="12:10 - 15:30" data-player="${player}" data-field="${f}" value="${value}" /></td>`;
        }).join("")}
      `;
      tbody.appendChild(tr);
    });

    document.querySelectorAll("input").forEach(input => {
      input.addEventListener("change", async e => {
        const player = e.target.dataset.player;
        const field = e.target.dataset.field;
        const value = e.target.value;

        data[player] = data[player] || {};
        data[player][field] = value;

        await saveDataToServer(data);
        calculateOptimal(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      });
    });
  }

  async function calculateOptimal() {
    const data = await loadDataFromServer();

    const results = {
      sat1: findOptimalTime(players.map(p => (data[p] && data[p].sat1) || "")),
      sat2: findOptimalTime(players.map(p => (data[p] && data[p].sat2) || "")),
      sun1: findOptimalTime(players.map(p => (data[p] && data[p].sun1) || "")),
      sun2: findOptimalTime(players.map(p => (data[p] && data[p].sun2) || ""))
    };

    let resultHTML = "<h2>–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∞:</h2>";
    resultHTML += `<p><strong>–°—É–±–±–æ—Ç–∞ 1:</strong> ${results.sat1.time}</p>`;
    resultHTML += `<ul>${results.sat1.players.map(p => `<li>${p}</li>`).join("")}</ul>`;

    resultHTML += `<p><strong>–°—É–±–±–æ—Ç–∞ 2:</strong> ${results.sat2.time}</p>`;
    resultHTML += `<ul>${results.sat2.players.map(p => `<li>${p}</li>`).join("")}</ul>`;

    resultHTML += `<p><strong>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 1:</strong> ${results.sun1.time}</p>`;
    resultHTML += `<ul>${results.sun1.players.map(p => `<li>${p}</li>`).join("")}</ul>`;

    resultHTML += `<p><strong>–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ 2:</strong> ${results.sun2.time}</p>`;
    resultHTML += `<ul>${results.sun2.players.map(p => `<li>${p}</li>`).join("")}</ul>`;

    document.getElementById("results").innerHTML = resultHTML;
  }

  async function init() {
    const data = await loadDataFromServer();
    await renderTable(data);
    await calculateOptimal(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  }

  window.calculateOptimal = calculateOptimal;

  init();
</script>

</body>
</html>
